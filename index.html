<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم متجر ويلي</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;900&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6C5CE7;
            --secondary: #FD79A8;
            --accent: #00CEFF;
            --success: #00B894;
            --warning: #FDCB6E;
            --danger: #D63031;
            --light: #F7F7F7;
            --dark: #2D3436;
        }
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Tajawal', sans-serif;
        }
        body {
            background-color: #f5f7fa;
            padding: 20px;
        }
        .admin-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--primary);
        }
        .admin-header h1 {
            color: var(--primary);
            font-size: 28px;
        }
        .logout-btn {
            background-color: var(--danger);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        .logout-btn:hover {
            background-color: #c0392b;
        }
        .products-management {
            background-color: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        .section-title {
            margin-bottom: 20px;
            color: var(--primary);
            font-size: 24px;
        }
        .add-product-btn {
            background-color: var(--success);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-bottom: 25px;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        .add-product-btn:hover {
            background-color: #00a884;
        }
        .products-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 16px;
        }
        .products-table th, .products-table td {
            padding: 15px;
            text-align: right;
            border-bottom: 1px solid #eee;
        }
        .products-table th {
            background-color: var(--light);
            color: var(--dark);
            font-weight: 700;
        }
        .products-table tr:hover {
            background-color: #f9f9f9;
        }
        .product-img {
            width: 70px;
            height: 70px;
            object-fit: cover;
            border-radius: 5px;
        }
        .action-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 16px;
            margin-left: 15px;
            transition: all 0.3s ease;
            padding: 5px;
        }
        .edit-btn {
            color: var(--primary);
        }
        .delete-btn {
            color: var(--danger);
        }
        .edit-btn:hover, .delete-btn:hover {
            transform: scale(1.1);
        }
        .product-form-container {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .product-form {
            background-color: white;
            width: 90%;
            max-width: 650px;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .form-title {
            color: var(--primary);
            margin-bottom: 25px;
            font-size: 24px;
        }
        .form-group {
            margin-bottom: 25px;
        }
        .form-group label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            font-size: 16px;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }
        .form-group textarea {
            min-height: 120px;
            resize: vertical;
        }
        .image-preview {
            margin-top: 15px;
        }
        .image-preview img {
            max-width: 120px;
            max-height: 120px;
            border-radius: 5px;
            border: 1px solid #ddd;
        }
        .form-actions {
            display: flex;
            justify-content: flex-start;
            gap: 15px;
            margin-top: 25px;
        }
        .save-btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        .save-btn:hover {
            background-color: #5d4acf;
        }
        .cancel-btn {
            background-color: #ddd;
            color: var(--dark);
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        .cancel-btn:hover {
            background-color: #ccc;
        }
        .notification {
            position: fixed;
            bottom: 30px;
            right: 30px;
            padding: 15px 25px;
            border-radius: 5px;
            color: white;
            display: none;
            z-index: 1100;
            font-size: 16px;
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
        }
        .success {
            background-color: var(--success);
        }
        .error {
            background-color: var(--danger);
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.7);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            color: white;
            font-size: 20px;
            flex-direction: column;
        }
        .loading-spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #6C5CE7;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .no-products {
            text-align: center;
            padding: 40px;
            color: #666;
            font-size: 18px;
        }
        @media (max-width: 768px) {
            .products-table {
                display: block;
                overflow-x: auto;
            }
            .product-form {
                width: 95%;
                padding: 20px;
            }
            .admin-header {
                flex-direction: column;
                gap: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- شاشة التحميل -->
    <div class="loading-overlay" id="loading">
        <div class="loading-spinner"></div>
        <div>جاري تحميل البيانات...</div>
    </div>

    <div class="admin-container">
        <div class="admin-header">
            <h1>لوحة تحكم متجر ويلي</h1>
            <button class="logout-btn" id="logout-btn">
                <i class="fas fa-sign-out-alt"></i> تسجيل الخروج
            </button>
        </div>
        <div class="products-management">
            <h2 class="section-title">إدارة المنتجات</h2>
            <button class="add-product-btn" id="add-product-btn">
                <i class="fas fa-plus"></i> إضافة منتج جديد
            </button>
            <table class="products-table">
                <thead>
                    <tr>
                        <th>الصورة</th>
                        <th>اسم المنتج</th>
                        <th>الفئة</th>
                        <th>السعر</th>
                        <th>الكمية</th>
                        <th>إجراءات</th>
                    </tr>
                </thead>
                <tbody id="products-table-body">
                    <tr>
                        <td colspan="6" class="no-products">جاري تحميل البيانات...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- نموذج إضافة/تعديل منتج -->
    <div class="product-form-container" id="product-form-container">
        <div class="product-form">
            <h2 class="form-title" id="form-title">إضافة منتج جديد</h2>
            <form id="product-form">
                <input type="hidden" id="product-id">
                <div class="form-group">
                    <label for="product-name">اسم المنتج</label>
                    <input type="text" id="product-name" required>
                </div>
                <div class="form-group">
                    <label for="product-category">الفئة</label>
                    <select id="product-category" required>
                        <option value="الهواتف">الهواتف</option>
                        <option value="الإلكترونيات">الإلكترونيات</option>
                        <option value="الأجهزة المنزلية">الأجهزة المنزلية</option>
                        <option value="الألعاب">الألعاب</option>
                        <option value="أخرى">أخرى</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="product-price">السعر (د.ت)</label>
                    <input type="number" id="product-price" step="0.01" min="0" required>
                </div>
                <div class="form-group">
                    <label for="product-old-price">السعر القديم (د.ت)</label>
                    <input type="number" id="product-old-price" step="0.01" min="0">
                </div>
                <div class="form-group">
                    <label for="product-quantity">الكمية المتاحة</label>
                    <input type="number" id="product-quantity" min="0" required>
                </div>
                <div class="form-group">
                    <label for="product-description">الوصف</label>
                    <textarea id="product-description"></textarea>
                </div>
                <div class="form-group">
                    <label for="product-image">صورة المنتج (رابط URL)</label>
                    <input type="url" id="product-image" placeholder="https://example.com/image.jpg">
                    <div class="image-preview">
                        <img id="image-preview" src="" style="display: none;">
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" class="save-btn" id="save-btn">
                        <i class="fas fa-save"></i> حفظ
                    </button>
                    <button type="button" class="cancel-btn" id="cancel-form">
                        <i class="fas fa-times"></i> إلغاء
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- إشعارات -->
    <div class="notification" id="notification"></div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script>
        // ========== تهيئة Firebase ==========
        const firebaseConfig = {
            apiKey: "AIzaSyD-2XyDdRd96bMkeSczg8VjSjmU8421v28",
            authDomain: "waelistore-88caa.firebaseapp.com",
            projectId: "waelistore-88caa",
            storageBucket: "waelistore-88caa.appspot.com",
            messagingSenderId: "688527524354",
            appId: "1:688527524354:web:f52aadb38526c6ea419db",
            measurementId: "G-G21VJBD3RR"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // ========== المتغيرات العامة ==========
        let isEditing = false;
        let currentProductId = null;
        
        // ========== عناصر DOM ==========
        const productsTableBody = document.getElementById('products-table-body');
        const addProductBtn = document.getElementById('add-product-btn');
        const productFormContainer = document.getElementById('product-form-container');
        const productForm = document.getElementById('product-form');
        const formTitle = document.getElementById('form-title');
        const productIdInput = document.getElementById('product-id');
        const cancelFormBtn = document.getElementById('cancel-form');
        const logoutBtn = document.getElementById('logout-btn');
        const saveBtn = document.getElementById('save-btn');
        const notification = document.getElementById('notification');
        const loadingOverlay = document.getElementById('loading');
        
        // ========== دوال المساعدة ==========
        function showLoading(show) {
            loadingOverlay.style.display = show ? 'flex' : 'none';
        }
        
        function showNotification(message, type) {
            notification.textContent = message;
            notification.className = `notification ${type}`;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }
        
        function resetForm() {
            productForm.reset();
            document.getElementById('image-preview').style.display = 'none';
            productIdInput.value = '';
            isEditing = false;
            currentProductId = null;
        }
        
        // ========== دوال إدارة المنتجات ==========
        function loadProducts() {
            showLoading(true);
            db.collection("products").get()
                .then((querySnapshot) => {
                    if (querySnapshot.empty) {
                        productsTableBody.innerHTML = `
                            <tr>
                                <td colspan="6" class="no-products">لا توجد منتجات متاحة حالياً</td>
                            </tr>
                        `;
                        return;
                    }
                    
                    productsTableBody.innerHTML = '';
                    querySnapshot.forEach((doc) => {
                        const product = doc.data();
                        productsTableBody.innerHTML += `
                            <tr>
                                <td><img src="${product.image || 'https://via.placeholder.com/70?text=لا+توجد+صورة'}" 
                                       alt="${product.name}" class="product-img"></td>
                                <td>${product.name || 'بدون اسم'}</td>
                                <td>${product.category || 'غير مصنف'}</td>
                                <td>${(product.price || 0).toLocaleString('ar-TN', {minimumFractionDigits: 2})} د.ت</td>
                                <td>${product.quantity || 0}</td>
                                <td>
                                    <button class="action-btn edit-btn" data-id="${doc.id}">
                                        <i class="fas fa-edit"></i> تعديل
                                    </button>
                                    <button class="action-btn delete-btn" data-id="${doc.id}">
                                        <i class="fas fa-trash"></i> حذف
                                    </button>
                                </td>
                            </tr>
                        `;
                    });
                    
                    // إضافة مستمعي الأحداث للأزرار الجديدة
                    document.querySelectorAll('.edit-btn').forEach(btn => {
                        btn.addEventListener('click', () => editProduct(btn.dataset.id));
                    });
                    
                    document.querySelectorAll('.delete-btn').forEach(btn => {
                        btn.addEventListener('click', () => deleteProduct(btn.dataset.id));
                    });
                })
                .catch((error) => {
                    console.error("خطأ في تحميل المنتجات:", error);
                    showNotification("حدث خطأ في تحميل المنتجات", "error");
                    productsTableBody.innerHTML = `
                        <tr>
                            <td colspan="6" class="no-products">حدث خطأ في تحميل البيانات</td>
                        </tr>
                    `;
                })
                .finally(() => {
                    showLoading(false);
                });
        }
        
        function editProduct(productId) {
            showLoading(true);
            db.collection("products").doc(productId).get()
                .then((doc) => {
                    if (doc.exists) {
                        const product = doc.data();
                        isEditing = true;
                        currentProductId = productId;
                        formTitle.textContent = "تعديل المنتج";
                        
                        // تعبئة النموذج
                        productIdInput.value = productId;
                        document.getElementById('product-name').value = product.name || '';
                        document.getElementById('product-category').value = product.category || 'الهواتف';
                        document.getElementById('product-price').value = product.price || '';
                        document.getElementById('product-old-price').value = product.oldPrice || '';
                        document.getElementById('product-quantity').value = product.quantity || '';
                        document.getElementById('product-description').value = product.description || '';
                        document.getElementById('product-image').value = product.image || '';
                        
                        // عرض معاينة الصورة
                        const imagePreview = document.getElementById('image-preview');
                        if (product.image) {
                            imagePreview.src = product.image;
                            imagePreview.style.display = 'block';
                        } else {
                            imagePreview.style.display = 'none';
                        }
                        
                        productFormContainer.style.display = 'flex';
                    } else {
                        showNotification("المنتج غير موجود", "error");
                    }
                })
                .catch((error) => {
                    console.error("خطأ في تحميل المنتج:", error);
                    showNotification("حدث خطأ في تحميل المنتج", "error");
                })
                .finally(() => {
                    showLoading(false);
                });
        }
        
        function deleteProduct(productId) {
            if (!confirm("هل أنت متأكد من حذف هذا المنتج؟")) return;
            
            showLoading(true);
            db.collection("products").doc(productId).delete()
                .then(() => {
                    showNotification("تم حذف المنتج بنجاح", "success");
                    loadProducts();
                })
                .catch((error) => {
                    console.error("خطأ في حذف المنتج:", error);
                    showNotification("حدث خطأ أثناء حذف المنتج", "error");
                })
                .finally(() => {
                    showLoading(false);
                });
        }
        
        function saveProduct(e) {
            e.preventDefault();
            
            // التحقق من صحة البيانات
            const name = document.getElementById('product-name').value.trim();
            const price = parseFloat(document.getElementById('product-price').value);
            const quantity = parseInt(document.getElementById('product-quantity').value);
            
            if (!name || isNaN(price) || isNaN(quantity)) {
                showNotification("الرجاء إدخال بيانات صحيحة (اسم، سعر، كمية)", "error");
                return;
            }
            
            const productData = {
                name: name,
                category: document.getElementById('product-category').value,
                price: price,
                quantity: quantity,
                description: document.getElementById('product-description').value.trim(),
                image: document.getElementById('product-image').value.trim(),
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            // إضافة السعر القديم إذا كان موجودًا
            const oldPrice = parseFloat(document.getElementById('product-old-price').value);
            if (!isNaN(oldPrice)) {
                productData.oldPrice = oldPrice;
            }
            
            showLoading(true);
            saveBtn.disabled = true;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الحفظ...';
            
            if (isEditing) {
                // تحديث المنتج
                db.collection("products").doc(currentProductId).update(productData)
                    .then(() => {
                        showNotification("تم تحديث المنتج بنجاح", "success");
                        productFormContainer.style.display = 'none';
                        resetForm();
                        loadProducts();
                    })
                    .catch((error) => {
                        console.error("خطأ في تحديث المنتج:", error);
                        showNotification(`حدث خطأ: ${error.message}`, "error");
                    })
                    .finally(() => {
                        showLoading(false);
                        saveBtn.disabled = false;
                        saveBtn.innerHTML = '<i class="fas fa-save"></i> حفظ';
                    });
            } else {
                // إضافة منتج جديد
                productData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                db.collection("products").add(productData)
                    .then(() => {
                        showNotification("تم إضافة المنتج بنجاح", "success");
                        productFormContainer.style.display = 'none';
                        resetForm();
                        loadProducts();
                    })
                    .catch((error) => {
                        console.error("خطأ في إضافة المنتج:", error);
                        showNotification(`حدث خطأ: ${error.message}`, "error");
                    })
                    .finally(() => {
                        showLoading(false);
                        saveBtn.disabled = false;
                        saveBtn.innerHTML = '<i class="fas fa-save"></i> حفظ';
                    });
            }
        }
        
        // ========== مستمعي الأحداث ==========
        document.addEventListener('DOMContentLoaded', () => {
            loadProducts();
            
            addProductBtn.addEventListener('click', () => {
                formTitle.textContent = "إضافة منتج جديد";
                resetForm();
                productFormContainer.style.display = 'flex';
            });
            
            cancelFormBtn.addEventListener('click', () => {
                productFormContainer.style.display = 'none';
                resetForm();
            });
            
            productForm.addEventListener('submit', saveProduct);
            
            logoutBtn.addEventListener('click', () => {
                if (confirm("هل أنت متأكد من تسجيل الخروج؟")) {
                    window.location.href = "login.html";
                }
            });
            
            document.getElementById('product-image').addEventListener('input', function() {
                const imageUrl = this.value;
                const imagePreview = document.getElementById('image-preview');
                
                if (imageUrl) {
                    imagePreview.src = imageUrl;
                    imagePreview.style.display = 'block';
                } else {
                    imagePreview.style.display = 'none';
                }
            });
        });
    </script>
</body>
</html>